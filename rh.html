<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Recruteur - ESTIA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        primary: '#0f172a', 
                        accent: '#3b82f6',
                    } 
                } 
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Navigation (Onglets) */
        .view { display: none; }
        .view.active { display: block; }
        
        .nav-link { position: relative; color: #94a3b8; transition: all 0.3s; cursor: pointer; }
        .nav-link:hover, .nav-link.active-link { color: #f8fafc; }
        .nav-link.active-link::after {
            content: ''; position: absolute; bottom: -20px; left: 0; width: 100%; height: 3px;
            background-color: #3b82f6; border-radius: 3px 3px 0 0;
        }

        .tab-btn-recruiter { position: relative; color: #64748b; transition: all 0.2s; }
        .tab-btn-recruiter:hover { color: #0f172a; }
        .tab-btn-recruiter.active-tab { color: #0f172a; font-weight: 600; }
        .tab-btn-recruiter.active-tab::after {
            content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px;
            background-color: #0f172a;
        }

        /* Modales instantanées (Pas de transition CSS) */
        .modal.hidden { display: none; }
        .modal.flex { display: flex; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <nav class="sticky top-0 z-50 bg-primary shadow-lg border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-10">
                    <div class="flex items-center gap-2">
                        <span class="text-xl font-bold tracking-tight text-white">ESTIA <span class="text-[10px] uppercase tracking-wider bg-white/10 text-white/80 px-2 py-0.5 rounded ml-1 font-medium">Recruteur</span></span>
                    </div>
                    <div class="hidden md:flex items-center gap-6">
                        <button onclick="switchView('recruiter')" id="nav-recruiter" class="nav-link active-link flex items-center gap-2 text-sm font-medium">
                            <i class="fa-solid fa-table-columns"></i> Tableau de bord
                        </button>
                        <button onclick="switchView('recruiter-profile')" id="nav-recruiter-profile" class="nav-link flex items-center gap-2 text-sm font-medium">
                            <i class="fa-solid fa-user-tie"></i> Mon Profil
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-medium text-white" id="header-name">Chargement...</p>
                        <p class="text-xs text-slate-400">Recruteur</p>
                    </div>
                    <div id="header-avatar" class="w-10 h-10 bg-gradient-to-br from-accent to-blue-700 rounded-full flex items-center justify-center text-white font-bold shadow-md border-2 border-primary">RH</div>
                    <button onclick="logout()" class="text-slate-400 hover:text-white transition p-2"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <section id="view-recruiter" class="view active">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Espace Recruteur</h1>
                    <p class="text-slate-500 mt-1">Gérez les candidatures et vos annonces.</p>
                </div>
                <button onclick="openCreateJobModal()" class="group bg-primary hover:bg-slate-800 text-white px-5 py-3 rounded-xl text-sm font-medium shadow-md transition flex items-center gap-2">
                    <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-plus text-xs"></i>
                    </div>
                    Créer une offre
                </button>
            </div>
            
            <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
                <div class="border-b border-slate-200 px-6 flex gap-8 bg-slate-50/50 sticky top-0 z-10">
                    <button id="btn-tab-candidatures" class="tab-btn-recruiter active-tab py-5 text-sm outline-none" onclick="switchRecruiterTab('candidatures')">
                        <i class="fa-solid fa-users-viewfinder mr-2"></i>Candidatures Reçues
                        <span class="ml-2 bg-blue-100 text-blue-700 text-xs font-bold px-2 py-0.5 rounded-full" id="badge-count-candidates">0</span>
                    </button>
                    <button id="btn-tab-offres" class="tab-btn-recruiter py-5 text-sm outline-none" onclick="switchRecruiterTab('offres')">
                        <i class="fa-solid fa-briefcase mr-2"></i>Mes Offres Actives
                    </button>
                </div>

                <div id="recruiter-tab-candidatures" class="block min-h-[400px]">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider bg-slate-50 border-b border-slate-200">
                                    <th class="px-6 py-4 cursor-pointer hover:text-primary transition" onclick="handleSort('name')">Candidat <i class="fa-solid fa-sort ml-1 opacity-50"></i></th>
                                    <th class="px-6 py-4">Poste visé</th>
                                    <th class="px-6 py-4 text-center cursor-pointer hover:text-primary transition" onclick="handleSort('date')">Reçu le <i class="fa-solid fa-sort ml-1 opacity-50"></i></th>
                                    <th class="px-6 py-4 text-center">CV</th>
                                    <th class="px-6 py-4 text-center">Statut</th>
                                    <th class="px-6 py-4 text-center">Contact</th>
                                </tr>
                            </thead>
                            <tbody id="recruiter-table-body" class="divide-y divide-slate-100">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="recruiter-tab-offres" class="hidden p-8 bg-slate-50/30">
                    <div id="my-jobs-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        </div>
                </div>
            </div>
        </section>

        <section id="view-recruiter-profile" class="view">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Profil Recruteur</h1>
                <p class="text-slate-500 mt-1">Vos informations visibles par les étudiants</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="bg-white border border-slate-200 rounded-2xl p-8 col-span-1 text-center shadow-sm h-fit">
                    <div class="relative inline-block mb-4">
                        <div id="rec-initials" class="w-28 h-28 bg-gradient-to-br from-blue-50 to-blue-100 text-blue-600 rounded-full flex items-center justify-center text-4xl font-bold shadow-inner mx-auto border-4 border-white">RH</div>
                        <div class="absolute bottom-1 right-1 w-6 h-6 bg-green-500 border-4 border-white rounded-full"></div>
                    </div>
                    <h2 id="rec-card-name" class="text-xl font-bold text-slate-900">...</h2>
                    <p id="rec-card-role" class="text-slate-500 font-medium">Recruteur</p>
                    
                    <div class="mt-6 pt-6 border-t border-slate-100 grid grid-cols-2 gap-4 text-center">
                        <div>
                            <span id="count-jobs" class="block text-2xl font-bold text-primary">0</span>
                            <span class="text-xs text-slate-400 uppercase font-semibold">Offres</span>
                        </div>
                        <div>
                            <span id="count-candidates" class="block text-2xl font-bold text-primary">0</span>
                            <span class="text-xs text-slate-400 uppercase font-semibold">Candidats</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white border border-slate-200 rounded-2xl p-8 col-span-1 lg:col-span-2 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-slate-900">Modifier les informations</h3>
                        <span class="text-xs font-medium px-3 py-1 bg-green-100 text-green-700 rounded-full">Compte actif</span>
                    </div>
                    <form class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1.5">Nom complet</label>
                                <input type="text" id="rec-name" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-accent outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1.5">Email professionnel</label>
                                <input type="email" id="rec-email" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-accent outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1.5">Téléphone (Affichage)</label>
                                <input type="text" id="rec-phone" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-accent outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1.5">Poste (Affichage)</label>
                                <input type="text" id="rec-role-input" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-accent outline-none" disabled>
                            </div>
                        </div>
                        <div class="pt-6 flex justify-end border-t border-slate-100 mt-2">
                            <button type="button" onclick="saveProfile()" class="bg-primary hover:bg-slate-800 text-white px-8 py-2.5 rounded-xl font-medium shadow-sm transition">Enregistrer</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

    </main>

    <div id="modal-create-job" class="modal fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-primary/40 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-0 relative z-10 overflow-hidden">
            <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 id="modal-title" class="font-bold text-xl text-slate-900">Publier une offre</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div class="p-8 space-y-5">
                <input type="hidden" id="job-id">
                
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1.5">Titre du poste</label>
                    <input type="text" id="job-title" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-accent outline-none" placeholder="ex: Ingénieur DevOps">
                </div>
                
                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1.5">Contrat</label>
                        <div class="relative">
                            <select id="job-type" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-accent outline-none appearance-none bg-white">
                                <option value="Stage">Stage</option>
                                <option value="Alternance">Alternance</option>
                                <option value="CDI">CDI</option>
                                <option value="CDD">CDD</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1.5">Secteur</label>
                        <div class="relative">
                            <select id="job-sector" class="w-full px-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-accent outline-none appearance-none bg-white">
                                <option value="aero">Aéronautique</option>
                                <option value="tech">Tech / IT</option>
                                <option value="energie">Énergie</option>
                                <option value="conseil">Conseil</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1.5">Lieu</label>
                    <div class="relative">
                        <i class="fa-solid fa-location-dot absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="job-location" class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-accent outline-none" placeholder="ex: Paris, Toulouse...">
                    </div>
                </div>
                
                <button onclick="submitJob()" class="w-full bg-primary hover:bg-slate-800 text-white py-3 rounded-xl font-bold mt-4 shadow-sm transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> Valider et Publier
                </button>
            </div>
        </div>
    </div>

    <div id="modal-generic" class="modal fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-primary/60 backdrop-blur-sm" onclick="closeGenericModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-0 relative z-10 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/80">
                <h3 id="modal-generic-title" class="font-bold text-lg text-slate-900">Notification</h3>
                <button onclick="closeGenericModal()" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-200">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            <div id="modal-generic-content" class="p-6"></div>
        </div>
    </div>

    <div id="modal-cv" class="modal fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-primary/60 backdrop-blur-sm" onclick="closeCVModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 h-[80vh] flex flex-col relative z-10">

            <input type="hidden" id="cv-hidden-candidate-id">
            <input type="hidden" id="cv-hidden-job-id">
            <input type="hidden" id="cv-hidden-position">

            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-red-100 text-red-600 rounded-lg flex items-center justify-center"><i class="fa-solid fa-file-pdf text-xl"></i></div>
                    <div><h3 class="font-bold text-slate-900" id="cv-candidate-name">Candidat</h3><p class="text-xs text-slate-500" id="cv-filename">document.pdf</p></div>
                </div>
                <button onclick="closeCVModal()" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-200"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="flex-1 bg-slate-100 p-8 flex items-center justify-center">
                <div class="bg-white p-10 shadow-lg text-center rounded-xl border border-slate-200">
                    <i class="fa-solid fa-file-lines text-6xl text-slate-200 mb-4"></i>
                    <h4 class="text-xl font-bold text-slate-800">Aperçu du CV</h4>
                    <p class="text-slate-500 text-sm mt-2">Ceci est une simulation de visualiseur PDF.</p>
                </div>
            </div>
            <div class="px-6 py-4 border-t flex justify-end gap-3 rounded-b-2xl bg-white">
                <button onclick="closeCVModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-50 rounded-lg transition font-medium border border-slate-200">Fermer</button>
                <button onclick="handleContact()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-slate-800 transition font-medium shadow-sm">Contacter le candidat</button>
            </div>
        </div>
    </div>

    <div id="modal-chat" class="modal fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeChatModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 relative z-10 overflow-hidden flex flex-col h-[600px]">
            <input type="hidden" id="chat-target-id">
            <input type="hidden" id="chat-job-id">
            
            <div class="px-6 py-4 border-b border-slate-100 bg-white flex justify-between items-center shadow-sm z-10">
                <div class="flex items-center gap-3">
                    <div id="chat-avatar" class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-sm">ET</div>
                    <div>
                        <h3 id="chat-candidate-name" class="font-bold text-slate-900 leading-tight">Candidat</h3>
                        <p id="chat-position" class="text-xs text-slate-500">Candidature</p>
                    </div>
                </div>
                <button onclick="closeChatModal()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-50"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50">
                </div>

            <div class="p-4 bg-white border-t border-slate-100">
                <form onsubmit="sendRecruiterMessage(event)" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Écrivez votre message..." autocomplete="off" class="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl shadow-sm flex items-center justify-center w-12 transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-notification" class="fixed inset-0 z-[200] hidden items-end justify-center sm:items-start sm:justify-end p-6 pointer-events-none">
        <div id="notif-content" class="bg-white border-l-4 border-accent shadow-2xl rounded-lg p-6 w-full max-w-sm pointer-events-auto flex flex-col gap-3">
            <div class="flex items-start gap-4">
                <div id="notif-icon" class="text-2xl text-accent pt-1">
                    <i class="fa-solid fa-bell"></i>
                </div>
                <div class="flex-1">
                    <h4 id="notif-title" class="font-bold text-slate-900 text-lg mb-1">Titre</h4>
                    <p id="notif-message" class="text-slate-600 text-sm">Message contenu...</p>
                </div>
                <button onclick="closeNotification()" class="text-slate-400 hover:text-slate-600 p-1">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <button id="notif-action-btn" class="hidden w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 rounded-lg transition shadow-sm flex items-center justify-center gap-2">
                <i class="fa-solid fa-comments"></i> Voir la conversation
            </button>
        </div>
    </div>

    <script>
        // Protection XSS
        function escapeHtml(text) {
            if (text == null) return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Variables globales
        let recruiterInfo = {};
        let jobs = [];
        let candidates = [];
        let currentSort = { col: 'date', order: 'desc' };

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSession();
            await fetchMyJobs();
            await fetchCandidates();
        });

        // Validation de l'authentification
        async function checkSession() {
            try {
                const res = await fetch('api.php?action=check_session');
                const data = await res.json();
                if(!data.logged_in || data.user.role !== 'recruiter') {
                    window.location.href = 'login.html';
                    return;
                }
                recruiterInfo = data.user;
                updateUI();
            } catch(e) { console.error("Session fetch failed:", e); }
        }

        function logout() {
            fetch('api.php?action=logout').then(() => window.location.href = 'login.html');
        }

        // Chargement des données 
        async function fetchMyJobs() {
            try {
                const res = await fetch('api.php?action=get_jobs&my_jobs=1');
                jobs = await res.json();
                renderJobs();
                updateStats();
            } catch(e) { console.error("Jobs fetch failed:", e); }
        }

        async function fetchCandidates() {
            try {
                const res = await fetch('api.php?action=get_applications');
                candidates = await res.json();
                renderCandidates();
                updateStats();
            } catch(e) { console.error("Candidates fetch failed:", e); }
        }

        // Mise à jour de l'interface
        function updateUI() {
            const name = escapeHtml(recruiterInfo.name || 'Recruteur');
            const initials = name.substring(0, 2).toUpperCase();

            document.getElementById('header-name').textContent = name;
            document.getElementById('header-avatar').textContent = initials;
            document.getElementById('rec-card-name').textContent = name;
            document.getElementById('rec-initials').textContent = initials;
            
            document.getElementById('rec-name').value = recruiterInfo.name || '';
            document.getElementById('rec-email').value = recruiterInfo.email || '';
            document.getElementById('rec-phone').value = recruiterInfo.phone || '';
            document.getElementById('rec-role-input').value = "Recruteur"; 
        }

        function updateStats() {
            if(document.getElementById('count-jobs')) document.getElementById('count-jobs').textContent = jobs.length;
            if(document.getElementById('count-candidates')) document.getElementById('count-candidates').textContent = candidates.length;
            if(document.getElementById('badge-count-candidates')) document.getElementById('badge-count-candidates').textContent = candidates.length;
        }

        // Sauvegarde profil
        async function saveProfile() {
            const payload = { 
                id: recruiterInfo.id, 
                name: document.getElementById('rec-name').value, 
                email: document.getElementById('rec-email').value, 
                phone: document.getElementById('rec-phone').value,
                role: 'recruiter', 
                status: 'active' 
            };
            
            try {
                const res = await fetch('api.php?action=update_user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                
                if(result.success) {
                    recruiterInfo.name = payload.name;
                    recruiterInfo.email = payload.email;
                    recruiterInfo.phone = payload.phone;
                    updateUI();
                    
                    showModal("Succès", `
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-check"></i></div>
                            <p class="text-lg font-bold text-slate-800">Profil mis à jour !</p>
                            <button onclick="closeGenericModal()" class="mt-6 px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition">OK</button>
                        </div>
                    `);
                }
            } catch(e) { console.error("Profile save failed:", e); }
        }

        // Navigation interne
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-link'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            document.getElementById(`nav-${viewId}`).classList.add('active-link');
        }

        function switchRecruiterTab(tab) {
            const c = document.getElementById('recruiter-tab-candidatures');
            const o = document.getElementById('recruiter-tab-offres');
            const b1 = document.getElementById('btn-tab-candidatures');
            const b2 = document.getElementById('btn-tab-offres');
            
            if(tab === 'candidatures') { 
                c.classList.remove('hidden'); o.classList.add('hidden'); 
                b1.classList.add('active-tab'); b2.classList.remove('active-tab'); 
            } else { 
                c.classList.add('hidden'); o.classList.remove('hidden'); 
                b1.classList.remove('active-tab'); b2.classList.add('active-tab'); 
            }
        }

        // Rendu Candidatures
        function renderCandidates() {
            const tbody = document.getElementById('recruiter-table-body');
            const styles = {
                nouveau:   { row: 'bg-amber-50/60', badge: 'bg-amber-100 text-amber-800' },
                entretien: { row: 'bg-blue-50/60',  badge: 'bg-blue-100 text-blue-800' },
                accepte:   { row: 'bg-green-50/60', badge: 'bg-green-100 text-green-800' },
                refuse:    { row: 'bg-red-50/60',   badge: 'bg-red-100 text-red-800' },
                en_attente:{ row: 'bg-slate-50/60', badge: 'bg-slate-100 text-slate-800' }
            };

            if(candidates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-slate-500">Aucune candidature reçue pour le moment.</td></tr>';
                return;
            }

            tbody.innerHTML = candidates.map(c => {
                const style = styles[c.status] || styles.en_attente;
                const name = escapeHtml(c.candidate_name || 'Inconnu');
                const initials = name.substring(0, 2).toUpperCase();

                return `
                <tr class="${style.row} transition group border-b border-slate-100">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-800 text-white flex items-center justify-center font-bold text-sm">
                                ${initials}
                            </div>
                            <div>
                                <div class="font-bold text-slate-800">${name}</div>
                                <div class="text-xs text-slate-500">${escapeHtml(c.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-600">${escapeHtml(c.position)}</td>
                    <td class="px-6 py-4 text-center text-sm text-slate-500">${new Date(c.date).toLocaleDateString('fr-FR')}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="openCandidateCV('${name}', ${c.candidate_user_id}, ${c.job_id}, '${escapeHtml(c.position)}')" class="text-xs bg-white hover:bg-white/80 text-slate-600 px-3 py-1.5 rounded-full border border-slate-200 transition mx-auto flex items-center gap-2">
                            <i class="fa-solid fa-file-pdf text-red-500"></i> PDF
                        </button>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="relative inline-block w-full max-w-[140px]">
                            <select onchange="updateStatus(${c.id}, this.value)" 
                                class="w-full text-xs font-bold py-1.5 pl-3 pr-8 rounded-full appearance-none cursor-pointer outline-none ${style.badge}">
                                <option value="en_attente" ${c.status === 'en_attente' ? 'selected' : ''}>En attente</option>
                                <option value="entretien" ${c.status === 'entretien' ? 'selected' : ''}>Entretien</option>
                                <option value="accepte" ${c.status === 'accepte' ? 'selected' : ''}>Accepté</option>
                                <option value="refuse" ${c.status === 'refuse' ? 'selected' : ''}>Refusé</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 opacity-60">
                                <i class="fa-solid fa-chevron-down text-[10px]"></i>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex justify-center gap-2">
                            <a href="mailto:${escapeHtml(c.email)}" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 flex items-center justify-center hover:bg-blue-600 hover:text-white transition" title="Email">
                                <i class="fa-solid fa-envelope"></i>
                            </a>
                            <button onclick="openChatModal('${c.candidate_user_id}', '${name}', '${escapeHtml(c.position)}', '${initials}', ${c.job_id})" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition" title="Message">
                                <i class="fa-solid fa-comments"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // Tri des candidats
        function handleSort(col) {
            currentSort.order = (currentSort.col === col && currentSort.order === 'asc') ? 'desc' : 'asc';
            currentSort.col = col;
            
            candidates.sort((a,b) => {
                let valA = (col === 'name') ? (a.candidate_name || '') : a[col];
                let valB = (col === 'name') ? (b.candidate_name || '') : b[col];
                
                if(valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                if(valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            renderCandidates();
        }

        // Mise à jour API du statut candidat
        async function updateStatus(id, val) {
            await fetch('api.php?action=update_status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, status: val })
            });
            fetchCandidates();
        }

        // Rendu Offres
        function renderJobs() {
            const grid = document.getElementById('my-jobs-grid');
            if (jobs.length === 0) { grid.innerHTML = '<p class="text-center col-span-2 text-slate-500 py-8">Aucune offre active.</p>'; return; }
            
            grid.innerHTML = jobs.map(j => `
                <div class="bg-white border border-slate-200 rounded-xl p-6 shadow-sm hover:shadow-lg transition relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-accent"></div>
                    <div class="flex justify-between mb-3 pl-3">
                        <div class="flex gap-2">
                            <span class="text-[10px] font-bold uppercase px-2.5 py-1 bg-blue-50 text-blue-700 rounded-full">${escapeHtml(j.type)}</span>
                            <span class="text-[10px] font-bold uppercase px-2.5 py-1 bg-slate-50 text-slate-600 rounded-full">${escapeHtml(j.sector || 'Autre')}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editJob(${j.id})" class="text-slate-400 hover:text-blue-600 p-1"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteJob(${j.id})" class="text-slate-400 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 pl-3">${escapeHtml(j.title)}</h3>
                    <p class="text-sm text-slate-500 mb-6 pl-3"><i class="fa-solid fa-location-dot text-slate-300"></i> ${escapeHtml(j.location)}</p>
                    <div class="pl-3 mt-auto pt-4 border-t flex justify-between text-sm">
                        <span class="text-slate-400">Publié le ${new Date(j.created_at).toLocaleDateString()}</span>
                        <span class="text-accent font-semibold cursor-pointer hover:underline" onclick="openJobDetails(${j.id})">Aperçu</span>
                    </div>
                </div>
            `).join('');
        }

        // Gestion des offres
        function openCreateJobModal() {
            document.getElementById('job-id').value = "";
            document.getElementById('job-title').value = "";
            document.getElementById('job-location').value = "";
            document.getElementById('job-type').selectedIndex = 0;
            document.getElementById('job-sector').selectedIndex = 0;
            
            document.getElementById('modal-title').innerText = "Publier une offre";
            document.getElementById('modal-create-job').classList.remove('hidden');
            document.getElementById('modal-create-job').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal-create-job').classList.add('hidden');
            document.getElementById('modal-create-job').classList.remove('flex');
        }
        
        async function submitJob() {
            const id = document.getElementById('job-id').value;
            const payload = {
                id: id,
                title: document.getElementById('job-title').value,
                location: document.getElementById('job-location').value,
                type: document.getElementById('job-type').value,
                sector: document.getElementById('job-sector').value
            };

            if (!payload.title || !payload.location) return alert("Remplissez les champs requis.");

            try {
                const res = await fetch('api.php?action=save_job', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const result = await res.json();
                if (result.success) {
                    closeModal();
                    fetchMyJobs();

                    const verb = id ? "modifiée" : "publiée";
                    showModal("Succès", `
                        <div class="text-center py-4">
                            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl"><i class="fa-solid fa-check"></i></div>
                            <h3 class="text-xl font-bold text-slate-900 mb-2">Offre ${verb} !</h3>
                            <button onclick="closeGenericModal()" class="mt-6 px-8 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700">Fermer</button>
                        </div>
                    `);
                }
            } catch (e) { console.error("Save job error:", e); }
        }

        function editJob(id) {
            const job = jobs.find(j => j.id == id);
            if (!job) return;
            
            document.getElementById('job-id').value = job.id;
            document.getElementById('job-title').value = job.title;
            document.getElementById('job-location').value = job.location;
            document.getElementById('job-type').value = job.type;
            if(job.sector) document.getElementById('job-sector').value = job.sector;
            
            document.getElementById('modal-title').innerText = "Modifier l'offre";
            document.getElementById('modal-create-job').classList.remove('hidden');
            document.getElementById('modal-create-job').classList.add('flex');
        }

        function deleteJob(id) {
            showModal("Confirmation", `
                <div class="text-center py-4">
                    <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-trash"></i></div>
                    <h3 class="text-lg font-bold text-slate-900">Supprimer l'offre ?</h3>
                    <p class="text-slate-500 mt-2 mb-6 text-sm">Toutes les candidatures liées seront perdues.</p>
                    <div class="flex justify-center gap-3">
                        <button onclick="closeGenericModal()" class="px-4 py-2 border border-slate-300 rounded-lg">Annuler</button>
                        <button onclick="confirmDeleteJob(${id})" class="px-4 py-2 bg-red-600 text-white rounded-lg">Confirmer</button>
                    </div>
                </div>
            `);
        }

        async function confirmDeleteJob(id) {
            try {
                const res = await fetch(`api.php?action=delete_job&id=${id}`);
                const result = await res.json();
                if(result.success) {
                    fetchMyJobs();
                    fetchCandidates();
                    showModal("Terminé", "<div class='text-center py-4'>L'offre a été supprimée.</div>");
                }
            } catch(e) { console.error("Delete job error:", e); }
        }

        // Modal détails offre
        function openJobDetails(jobId) {
            const job = jobs.find(j => j.id == jobId);
            if (!job) return;

            showModal("Détails de l'offre", `
                <div class="space-y-4">
                    <h4 class="font-bold text-slate-900 text-lg">${escapeHtml(job.title)}</h4>
                    <p class="text-slate-500">${escapeHtml(job.company)} • ${escapeHtml(job.location)}</p>
                    <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                        <div class="bg-slate-50 p-2 rounded">Contrat: <b>${escapeHtml(job.type)}</b></div>
                        <div class="bg-slate-50 p-2 rounded">Secteur: <b class="capitalize">${escapeHtml(job.sector)}</b></div>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button onclick="closeGenericModal()" class="px-4 py-2 bg-slate-200 rounded-lg">Fermer</button>
                    </div>
                </div>
            `);
        }

        function showModal(title, contentHtml) {
            const m = document.getElementById('modal-generic');
            document.getElementById('modal-generic-title').innerText = title;
            document.getElementById('modal-generic-content').innerHTML = contentHtml;
            m.classList.remove('hidden'); m.classList.add('flex');
        }

        function closeGenericModal() {
            const m = document.getElementById('modal-generic');
            m.classList.add('hidden'); m.classList.remove('flex');
        }

        // Gestion CV
        function openCandidateCV(name, candidateId, jobId, position) {
            const m = document.getElementById('modal-cv');
            document.getElementById('cv-candidate-name').textContent = name;
            document.getElementById('cv-filename').textContent = `CV_${name.replace(/\s/g,'_')}.pdf`;
            
            document.getElementById('cv-hidden-candidate-id').value = candidateId;
            document.getElementById('cv-hidden-job-id').value = jobId;
            document.getElementById('cv-hidden-position').value = position;

            m.classList.remove('hidden'); m.classList.add('flex');
        }

        function closeCVModal() {
            document.getElementById('modal-cv').classList.add('hidden');
            document.getElementById('modal-cv').classList.remove('flex');
        }

        function handleContact() {
            closeCVModal();
            const name = document.getElementById('cv-candidate-name').textContent;
            const candidateId = document.getElementById('cv-hidden-candidate-id').value;
            const jobId = document.getElementById('cv-hidden-job-id').value;
            const position = document.getElementById('cv-hidden-position').value;
            const initials = name.substring(0, 2).toUpperCase();
            
            openChatModal(candidateId, name, position, initials, jobId);
        }

        // Gestion Chat
        let chatInterval = null; 
        let currentJobId = null;

        async function openChatModal(candidateId, name, position, initials, jobId) {
            currentJobId = jobId; 
            document.getElementById('chat-target-id').value = candidateId;
            document.getElementById('chat-job-id').value = jobId; 

            document.getElementById('chat-candidate-name').textContent = name;
            document.getElementById('chat-position').textContent = position;
            document.getElementById('chat-avatar').textContent = initials;
            
            await loadMessages();
            if (chatInterval) clearInterval(chatInterval);
            chatInterval = setInterval(loadMessages, 3000);

            const m = document.getElementById('modal-chat');
            m.classList.remove('hidden'); m.classList.add('flex');
            setTimeout(() => document.getElementById('chat-input').focus(), 100);
        }

        async function loadMessages() {
            const targetId = document.getElementById('chat-target-id').value;
            const jobId = currentJobId || document.getElementById('chat-job-id').value;
            if (!targetId || !jobId) return;

            try {
                const res = await fetch(`api.php?action=get_messages&contact_id=${targetId}&job_id=${jobId}`);
                const messages = await res.json();
                const container = document.getElementById('chat-messages');
                container.innerHTML = ''; 

                if (messages.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-400 text-sm mt-4">Démarrez la conversation.</p>';
                    return;
                }

                messages.forEach(msg => {
                    const isMe = (parseInt(msg.sender_id) === parseInt(recruiterInfo.id));
                    const alignClass = isMe ? 'justify-end' : 'justify-start';
                    const bubbleColor = isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-200 rounded-tl-none';
                    const avatar = isMe ? '' : `<div class="w-8 h-8 bg-slate-200 text-slate-600 rounded-full flex items-center justify-center font-bold text-xs shrink-0 mr-2">ET</div>`;

                    container.innerHTML += `
                        <div class="flex ${alignClass} mb-3">
                            ${avatar}
                            <div class="${bubbleColor} p-3 rounded-2xl shadow-sm text-sm max-w-[80%] break-words">
                                ${escapeHtml(msg.message)}
                            </div>
                        </div>`;
                });
            } catch (e) { console.error("Chat load error:", e); }
        }

        function closeChatModal() {
            if (chatInterval) clearInterval(chatInterval);
            document.getElementById('modal-chat').classList.add('hidden');
            document.getElementById('modal-chat').classList.remove('flex');
            document.getElementById('chat-target-id').value = '';
        }

        async function sendRecruiterMessage(event) {
            event.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            const targetId = document.getElementById('chat-target-id').value;
            const jobId = document.getElementById('chat-job-id').value;

            if (message && targetId && jobId) {
                try {
                    await fetch('api.php?action=send_message', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ receiver_id: targetId, message: message, job_id: jobId })
                    });
                    
                    input.value = ""; 
                    await loadMessages();   
                    const container = document.getElementById('chat-messages');
                    container.scrollTop = container.scrollHeight;
                } catch (e) { console.error("Send message error:", e); }
            }
        }

        // Polling notifications
        setInterval(checkNotifications, 5000);

        async function checkNotifications() {
            try {
                const res = await fetch('api.php?action=check_notifications');
                const notifs = await res.json();
                if (notifs && notifs.length > 0) {
                    const notif = notifs[notifs.length - 1];
                    showNotificationModal(notif.type, notif.title, notif.message, notif.data);
                    fetchCandidates(); 
                }
            } catch(e) { console.error("Polling error:", e); }
        }

        function showNotificationModal(type, title, message, dataJson) {
            const modal = document.getElementById('modal-notification');
            const btn = document.getElementById('notif-action-btn');
            
            document.getElementById('notif-title').textContent = title;
            document.getElementById('notif-message').textContent = message;
            btn.classList.add('hidden'); 

            if (type === 'message' && dataJson) {
                try {
                    const data = (typeof dataJson === 'string') ? JSON.parse(dataJson) : dataJson;
                    const initials = data.name ? data.name.substring(0, 2).toUpperCase() : 'ET';

                    btn.onclick = function() {
                        openChatModal(data.recruiter_id, data.name, "Candidature", initials, data.job_id);
                        closeNotification();
                    };
                    btn.classList.remove('hidden');
                } catch (e) { console.error(e); }
            }
            modal.classList.remove('hidden');
        }

        function closeNotification() {
            document.getElementById('modal-notification').classList.add('hidden');
        }
    </script>
</body>
</html>