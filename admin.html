<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - ESTIA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        primary: '#0f172a', 
                        'primary-foreground': '#f8fafc',
                        accent: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    } 
                } 
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Navigation (Onglets) */
        .view { display: none; }
        .view.active { display: block; }
        
        .nav-link { cursor: pointer; transition: all 0.2s; border-bottom: 2px solid transparent; color: #94a3b8; }
        .nav-link:hover { background-color: rgba(255,255,255,0.1); color: #f8fafc; }
        .nav-link.active-link { background-color: rgba(255,255,255,0.15); border-bottom: 2px solid #3b82f6; color: #f8fafc; }

        /* Animation toast (conservée car utile pour les alertes éphémères) */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        
        /* Modales instantanées */
        .modal.hidden, #modal-edit-user.hidden, #modal-job-details.hidden, #modal-delete-user.hidden, #modal-delete-job.hidden, #modal-delete-reported.hidden, #modal-dismiss-report.hidden { display: none; }
        .modal.flex, #modal-edit-user.flex, #modal-job-details.flex, #modal-delete-user.flex, #modal-delete-job.flex, #modal-delete-reported.flex, #modal-dismiss-report.flex { display: flex; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <nav class="sticky top-0 z-50 bg-primary text-primary-foreground shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-8">
                    <span class="text-2xl font-bold tracking-tight text-white">ESTIA <span class="bg-red-500 text-white text-[10px] uppercase font-bold px-2 py-0.5 rounded ml-1">Admin</span></span>
                    <div class="flex items-center gap-1">
                        <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-link active-link px-4 py-2 rounded-md flex items-center gap-2 text-sm font-medium">
                            <i class="fa-solid fa-chart-line"></i> Dashboard
                        </button>
                        <button onclick="switchView('jobs')" id="nav-jobs" class="nav-link px-4 py-2 rounded-md flex items-center gap-2 text-sm font-medium">
                            <i class="fa-solid fa-briefcase"></i> Gestion Offres
                        </button>
                        <button onclick="switchView('reports')" id="nav-reports" class="nav-link px-4 py-2 rounded-md flex items-center gap-2 text-sm font-medium">
                            <i class="fa-solid fa-triangle-exclamation"></i> Signalements
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-medium text-white" id="admin-name">Administrateur</p>
                        <p class="text-xs text-slate-400">Super User</p>
                    </div>
                    <div class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold border border-slate-600">AD</div>
                    <button onclick="logout()" class="ml-4 text-slate-400 hover:text-white transition"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <section id="view-dashboard" class="view active">
            <div class="flex justify-between items-end mb-6">
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Vue d'ensemble</h1>
                <p class="text-sm text-slate-500">Dernière mise à jour: <span id="last-update">En cours...</span></p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card bg-white border border-slate-200 rounded-xl p-6 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <h3 class="text-sm font-medium text-slate-500 uppercase tracking-wide">Utilisateurs</h3>
                        <p class="text-3xl font-bold text-slate-900 mt-1" id="stat-users">0</p>
                        <span class="text-xs text-green-600 font-medium bg-green-50 px-2 py-0.5 rounded-full mt-2 inline-block">Total inscrits</span>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center text-accent"><i class="fa-solid fa-users text-xl"></i></div>
                </div>
                <div class="card bg-white border border-slate-200 rounded-xl p-6 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <h3 class="text-sm font-medium text-slate-500 uppercase tracking-wide">Offres en ligne</h3>
                        <p class="text-3xl font-bold text-slate-900 mt-1" id="stat-jobs">0</p>
                        <span class="text-xs text-slate-400 font-medium mt-2 inline-block">Visibles étudiants</span>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-purple-50 flex items-center justify-center text-purple-600"><i class="fa-solid fa-briefcase text-xl"></i></div>
                </div>
                <div class="card bg-white border border-slate-200 rounded-xl p-6 shadow-sm flex items-center justify-between hover:shadow-md transition">
                    <div>
                        <h3 class="text-sm font-medium text-slate-500 uppercase tracking-wide">Candidatures</h3>
                        <p class="text-3xl font-bold text-slate-900 mt-1" id="stat-candidatures">0</p>
                        <span class="text-xs text-orange-600 font-medium bg-orange-50 px-2 py-0.5 rounded-full mt-2 inline-block">Total plateforme</span>
                    </div>
                    <div class="w-12 h-12 rounded-xl bg-orange-50 flex items-center justify-center text-warning"><i class="fa-solid fa-file-contract text-xl"></i></div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <div class="p-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50/50">
                    <h3 class="font-bold text-lg text-slate-900">Base Utilisateurs</h3>
                    <div class="flex gap-3 w-full sm:w-auto">
                        <select id="role-filter" class="border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-accent outline-none" onchange="renderUsers()">
                            <option value="all">Tous les rôles</option>
                            <option value="student">Étudiants</option>
                            <option value="recruiter">Recruteurs</option>
                        </select>
                        <div class="relative w-full sm:w-64">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                            <input type="text" id="user-search" placeholder="Rechercher un nom, email..." class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-accent outline-none" oninput="renderUsers()">
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                            <tr>
                                <th class="p-4">Utilisateur</th>
                                <th class="p-4">Rôle</th>
                                <th class="p-4">Date Inscription</th>
                                <th class="p-4 text-center">Statut</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-slate-100 text-sm">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-jobs" class="view">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Modération des Offres</h1>
                    <p class="text-slate-500 mt-1">Validez ou supprimez les offres publiées par les recruteurs.</p>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                            <tr>
                                <th class="p-4">Poste & Entreprise</th>
                                <th class="p-4">Type</th>
                                <th class="p-4">Lieu</th>
                                <th class="p-4 text-center">Statut</th>
                                <th class="p-4 text-right">Modération</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body" class="divide-y divide-slate-100 text-sm">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-reports" class="view">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Signalements</h1>
                    <p class="text-slate-500 mt-1">Gérez les offres signalées par les étudiants.</p>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                            <tr>
                                <th class="p-4">Offre Concernée</th>
                                <th class="p-4">Raison</th>
                                <th class="p-4">Signalé par</th>
                                <th class="p-4">Date</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body" class="divide-y divide-slate-100 text-sm">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <div id="modal-edit-user" class="fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal('modal-edit-user')"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 relative z-10 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Modifier l'utilisateur</h3>
                <button onclick="closeModal('modal-edit-user')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <form onsubmit="saveUserChanges(event)" class="p-6 space-y-4">
                <input type="hidden" id="edit-user-id">
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nom complet</label>
                    <input type="text" id="edit-user-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent outline-none" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="edit-user-email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent outline-none" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Rôle</label>
                        <select id="edit-user-role" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent outline-none bg-white">
                            <option value="student">Étudiant</option>
                            <option value="recruiter">Recruteur</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Statut</label>
                        <select id="edit-user-status" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-accent outline-none bg-white">
                            <option value="active">Actif</option>
                            <option value="pending">En attente</option>
                            <option value="inactive">Inactif</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeModal('modal-edit-user')" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium">Annuler</button>
                    <button type="submit" class="px-6 py-2 bg-primary hover:bg-slate-800 text-white rounded-lg font-medium shadow-sm">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-job-details" class="fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal('modal-job-details')"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 relative z-10 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Détails de l'offre</h3>
                <button onclick="closeModal('modal-job-details')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div id="job-details-content" class="p-6 space-y-4">
                </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end">
                <button onclick="closeModal('modal-job-details')" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg">Fermer</button>
            </div>
        </div>
    </div>

    <div id="modal-delete-user" class="fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal('modal-delete-user')"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 relative z-10 overflow-hidden p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-2xl">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Êtes-vous sûr ?</h3>
            <p class="text-slate-500 text-sm mb-6">Cette action est irréversible. L'utilisateur sera définitivement supprimé.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('modal-delete-user')" class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-bold rounded-xl hover:bg-slate-50">Annuler</button>
                <button onclick="confirmDeleteUser()" class="flex-1 px-4 py-2.5 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-sm">Supprimer</button>
            </div>
        </div>
    </div>

    <div id="modal-delete-job" class="fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal('modal-delete-job')"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 relative z-10 overflow-hidden p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-2xl">
                <i class="fa-solid fa-trash-can"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Supprimer l'offre ?</h3>
            <p class="text-slate-500 text-sm mb-6">Cette action est irréversible. L'offre sera retirée de la plateforme.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('modal-delete-job')" class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-bold rounded-xl hover:bg-slate-50">Annuler</button>
                <button onclick="confirmDeleteJob()" class="flex-1 px-4 py-2.5 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-sm">Confirmer</button>
            </div>
        </div>
    </div>

    <div id="modal-delete-reported" class="fixed inset-0 z-[150] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal('modal-delete-reported')"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 relative z-10 overflow-hidden p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 text-2xl">
                <i class="fa-solid fa-trash-can"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Supprimer l'offre ?</h3>
            <p class="text-slate-500 text-sm mb-6">L'offre sera retirée définitivement et le signalement sera marqué comme traité.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('modal-delete-reported')" class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-bold rounded-xl hover:bg-slate-50">Annuler</button>
                <button onclick="confirmDeleteReported()" class="flex-1 px-4 py-2.5 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 shadow-sm">Supprimer</button>
            </div>
        </div>
    </div>

    <div id="modal-dismiss-report" class="fixed inset-0 z-[150] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeModal('modal-dismiss-report')"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 relative z-10 overflow-hidden p-6 text-center">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600 text-2xl">
                <i class="fa-solid fa-check-double"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Ignorer le signalement ?</h3>
            <p class="text-slate-500 text-sm mb-6">Le signalement sera supprimé de la liste sans impacter l'offre.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal('modal-dismiss-report')" class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-bold rounded-xl hover:bg-slate-50">Annuler</button>
                <button onclick="confirmDismissReport()" class="flex-1 px-4 py-2.5 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 shadow-sm">Ignorer</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-3"></div>

    <script>
        // --- Sécurité XSS ---
        function escapeHtml(text) {
            if (text == null) return "";
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Contexte ---
        let users = [];
        let jobs = [];
        let targetUserId = null;

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSession();
            await loadUsers();
            await loadJobs();
            await loadReports();
            await loadAllStats(); 
            
            document.getElementById('last-update').textContent = new Date().toLocaleDateString('fr-FR', {hour:'2-digit', minute:'2-digit'});
        });

        // Validation d'accès administrateur
        async function checkSession() {
            try {
                const res = await fetch('api.php?action=check_session');
                const data = await res.json();
                if(!data.logged_in || data.user.role !== 'admin') {
                    window.location.href = 'login.html';
                } else {
                    document.getElementById('admin-name').textContent = escapeHtml(data.user.name);
                }
            } catch(e) { console.error(e); }
        }

        function logout() {
            fetch('api.php?action=logout').then(() => window.location.href = 'login.html');
        }

        // Récupération des données utilisateurs
        async function loadUsers() {
            try {
                const res = await fetch('api.php?action=get_users');
                users = await res.json();
                renderUsers();
                renderDashboard();
            } catch(e) { console.error("Load users failed", e); }
        }

        // Récupération globale des offres
        async function loadJobs() {
            try {
                const res = await fetch('api.php?action=get_jobs&admin=1');
                jobs = await res.json();
                renderJobsTable();
                renderDashboard();
            } catch(e) { console.error("Load jobs failed", e); }
        }

        // Récupération agrégée des candidatures
        async function loadAllStats() {
            try {
                const res = await fetch('api.php?action=get_applications'); 
                const data = await res.json();
                if(Array.isArray(data)) {
                    document.getElementById('stat-candidatures').textContent = data.length;
                }
            } catch(e) { console.log("Candidature stats unavailable", e); }
        }

        // Mise à jour des KPI du Dashboard
        function renderDashboard() {
            document.getElementById('stat-users').textContent = users.length;
            document.getElementById('stat-jobs').textContent = jobs.filter(j => j.status === 'published').length;
        }

        // Rendu Table Utilisateurs
        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            const search = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;

            const filteredUsers = users.filter(user => {
                const name = user.name || "";
                const email = user.email || "";
                const matchSearch = name.toLowerCase().includes(search) || email.toLowerCase().includes(search);
                const matchRole = roleFilter === 'all' || user.role === roleFilter;
                return matchSearch && matchRole;
            });

            if(filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-slate-500">Aucun utilisateur trouvé.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredUsers.map(user => {
                let roleBadge = '';
                const isAdmin = user.role === 'admin';

                if(user.role === 'student') roleBadge = '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold border border-blue-200">Étudiant</span>';
                else if(user.role === 'recruiter') roleBadge = '<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold border border-purple-200">Recruteur</span>';
                else roleBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold border border-red-200">Admin</span>';
                
                const statusColor = user.status === 'active' ? 'text-green-600' : (user.status === 'pending' ? 'text-orange-500' : 'text-danger');
                const statusLabel = user.status === 'active' ? 'Actif' : (user.status === 'pending' ? 'En attente' : 'Inactif');
                const name = escapeHtml(user.name || "Inconnu");
                const initials = name.substring(0, 2).toUpperCase();
                const dateStr = user.created_at ? new Date(user.created_at).toLocaleDateString('fr-FR') : '-';

                const actionBtns = isAdmin 
                    ? `<span class="text-xs text-slate-400 italic mr-2">Protégé</span>` 
                    : `<button onclick="editUser(${user.id})" class="text-slate-400 hover:text-accent p-2 rounded-full hover:bg-blue-50 transition" title="Modifier"><i class="fa-solid fa-pen"></i></button>
                       <button onclick="deleteUser(${user.id})" class="text-slate-400 hover:text-danger p-2 rounded-full hover:bg-red-50 transition" title="Supprimer"><i class="fa-solid fa-trash"></i></button>`;

                return `
                <tr class="hover:bg-slate-50 transition group border-b border-slate-100 last:border-0">
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold text-xs border border-slate-300 shadow-sm">${initials}</div>
                            <div>
                                <div class="font-bold text-slate-900">${name}</div>
                                <div class="text-xs text-slate-500">${escapeHtml(user.email)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">${roleBadge}</td>
                    <td class="p-4 text-slate-500">${dateStr}</td>
                    <td class="p-4 text-center">
                        <span class="inline-flex items-center gap-1.5 ${statusColor} font-medium text-xs bg-white px-2 py-1 rounded-full border border-slate-100 shadow-sm">
                            <i class="fa-solid fa-circle text-[6px]"></i> ${statusLabel}
                        </span>
                    </td>
                    <td class="p-4 text-right">${actionBtns}</td>
                </tr>`;
            }).join('');
        }

        // Rendu Table Offres
        function renderJobsTable() {
            const tbody = document.getElementById('jobs-table-body');
            
            if(jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-slate-500">Aucune offre.</td></tr>';
                return;
            }

            tbody.innerHTML = jobs.map(job => {
                const isPending = job.status === 'pending';
                const statusBadge = isPending 
                    ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded font-bold border border-yellow-200"><i class="fa-solid fa-clock mr-1"></i>En attente</span>'
                    : '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded font-bold border border-green-200"><i class="fa-solid fa-check mr-1"></i>Publié</span>';

                const actions = isPending 
                    ? `<button onclick="validateJob(${job.id})" class="text-green-600 hover:bg-green-50 px-3 py-1 rounded border border-green-200 text-xs font-bold transition mr-2">Valider</button>
                        <button onclick="openDeleteJobModal(${job.id})" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200 text-xs font-bold transition">Rejeter</button>`
                    : `<button onclick="openDeleteJobModal(${job.id})" class="text-slate-400 hover:text-danger p-2"><i class="fa-solid fa-trash"></i></button>`;

                return `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                    <td class="p-4">
                        <div class="font-bold text-slate-900">${escapeHtml(job.title)}</div>
                        <div class="text-xs text-slate-500 font-medium uppercase tracking-wide">${escapeHtml(job.company)}</div>
                    </td>
                    <td class="p-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">${escapeHtml(job.type)}</span></td>
                    <td class="p-4 text-slate-500"><i class="fa-solid fa-location-dot text-slate-300 mr-1"></i>${escapeHtml(job.location)}</td>
                    <td class="p-4 text-center">${statusBadge}</td>
                    <td class="p-4 text-right flex justify-end gap-1 items-center">
                        <button onclick="viewJobDetails(${job.id})" class="text-slate-400 hover:text-blue-500 p-2 rounded hover:bg-slate-100 transition mr-1" title="Voir détails">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        ${actions}
                    </td>
                </tr>`;
            }).join('');
        }

        // --- GESTION DES MODALES GÉNÉRIQUES ---
        function openModal(modalId) {
            const m = document.getElementById(modalId);
            m.classList.remove('hidden'); m.classList.add('flex');
        }

        function closeModal(modalId) {
            const m = document.getElementById(modalId);
            m.classList.add('hidden'); m.classList.remove('flex');
        }

        // --- GESTION UTILISATEURS (CRUD) ---
        function editUser(id) {
            const user = users.find(u => u.id == id);
            if (!user) return;
            if (user.role === 'admin') { showToast("Impossible de modifier un administrateur", "danger"); return; }

            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-role').value = user.role;
            document.getElementById('edit-user-status').value = user.status;
            openModal('modal-edit-user');
        }

        async function saveUserChanges(event) {
            event.preventDefault(); 
            const payload = {
                id: document.getElementById('edit-user-id').value,
                name: document.getElementById('edit-user-name').value,
                email: document.getElementById('edit-user-email').value,
                role: document.getElementById('edit-user-role').value,
                status: document.getElementById('edit-user-status').value
            };

            await fetch('api.php?action=update_user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            loadUsers();
            closeModal('modal-edit-user');
            showToast("Utilisateur mis à jour", "success");
        }

        function deleteUser(id) {
            const user = users.find(u => u.id == id);
            if (user && user.role === 'admin') { showToast("Impossible de supprimer un administrateur", "danger"); return; }
            
            targetUserId = id;
            openModal('modal-delete-user');
        }

        async function confirmDeleteUser() {
            if (targetUserId !== null) {
                await fetch(`api.php?action=delete_user&id=${targetUserId}`);
                loadUsers();
                closeModal('modal-delete-user');
                showToast("Utilisateur supprimé", "success");
                targetUserId = null;
            }
        }

        // --- GESTION OFFRES (Modération) ---
        async function validateJob(id) {
            await fetch('api.php?action=validate_job', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id })
            });
            loadJobs();
            showToast("Offre approuvée", "success");
        }

        let targetJobId = null;
        function openDeleteJobModal(id) {
            targetJobId = id;
            openModal('modal-delete-job');
        }

        async function confirmDeleteJob() {
            if (targetJobId !== null) {
                await fetch(`api.php?action=delete_job&id=${targetJobId}`);
                loadJobs();
                closeModal('modal-delete-job');
                showToast("Offre supprimée", "danger");
                targetJobId = null;
            }
        }

        function viewJobDetails(id) {
            const job = jobs.find(j => j.id == id);
            if(!job) return;

            const companyInitial = job.company ? escapeHtml(job.company[0].toUpperCase()) : 'E';

            document.getElementById('job-details-content').innerHTML = `
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold text-xl">
                        ${companyInitial}
                    </div>
                    <div>
                        <h4 class="font-bold text-lg text-slate-900">${escapeHtml(job.title)}</h4>
                        <p class="text-sm text-slate-500">${escapeHtml(job.company)} • ${escapeHtml(job.location)}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-slate-50 p-3 rounded border border-slate-100">
                        <span class="block text-xs text-slate-400 font-bold uppercase">Type</span>
                        <span class="font-medium text-slate-800">${escapeHtml(job.type)}</span>
                    </div>
                    <div class="bg-slate-50 p-3 rounded border border-slate-100">
                        <span class="block text-xs text-slate-400 font-bold uppercase">Secteur</span>
                        <span class="font-medium text-slate-800 capitalize">${escapeHtml(job.sector || 'Non défini')}</span>
                    </div>
                </div>
                <div class="text-sm text-slate-600 bg-slate-50 p-4 rounded border border-slate-100 h-32 overflow-y-auto">
                    <p><strong>Description :</strong></p>
                    <p class="mt-1">${escapeHtml(job.description || "Aucune description fournie.")}</p>
                </div>
            `;
            openModal('modal-job-details');
        }

        // --- GESTION DES SIGNALEMENTS ---
        let reports = [];
        let reportIdToAction = null;
        let jobIdToAction = null;

        async function loadReports() {
            try {
                const res = await fetch('api.php?action=get_reports');
                reports = await res.json();
                renderReportsTable();
            } catch(e) { console.error("Reports load failed", e); }
        }

        function renderReportsTable() {
            const tbody = document.getElementById('reports-table-body');
            
            if(reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-slate-400">Aucun signalement en attente.</td></tr>';
                return;
            }

            tbody.innerHTML = reports.map(r => {
                let reasonBadge = '<span class="inline-block bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs font-bold border border-slate-200">Autre</span>';
                if(r.reason === 'fraud') reasonBadge = '<span class="inline-block bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold border border-red-200">Fraude</span>';
                if(r.reason === 'spam') reasonBadge = '<span class="inline-block bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold border border-orange-200">Spam</span>';
                if(r.reason === 'discrimination') reasonBadge = '<span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold border border-yellow-200">Discrimination</span>';

                return `
                <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                    <td class="p-4 align-middle">
                        <div class="font-bold text-slate-900">${escapeHtml(r.job_title)}</div>
                        <div class="text-xs text-slate-500 uppercase">${escapeHtml(r.company)}</div>
                    </td>
                    <td class="p-4 align-middle">${reasonBadge}</td>
                    <td class="p-4 text-slate-600 align-middle">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-slate-200 rounded-full flex items-center justify-center text-[10px] font-bold text-slate-600 shadow-sm">ET</div>
                            <span class="text-sm font-medium">${escapeHtml(r.reporter_name)}</span>
                        </div>
                    </td>
                    <td class="p-4 text-slate-500 align-middle text-sm">${new Date(r.created_at).toLocaleDateString('fr-FR')}</td>
                    <td class="p-4 align-middle">
                        <div class="flex justify-end items-center gap-2">
                            <button onclick="viewJobDetails(${r.job_id})" class="bg-white border border-slate-200 text-slate-600 hover:text-blue-600 hover:border-blue-300 px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm flex items-center gap-1">
                                <i class="fa-solid fa-eye"></i> Voir
                            </button>
                            <button onclick="openDeleteReportedModal(${r.job_id}, ${r.id})" class="bg-white border border-red-200 text-red-600 hover:bg-red-50 px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm flex items-center gap-1">
                                <i class="fa-solid fa-trash"></i> Supprimer
                            </button>
                            <button onclick="openDismissReportModal(${r.id})" class="bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 px-3 py-1.5 rounded-lg text-xs font-bold transition shadow-sm flex items-center gap-1">
                                <i class="fa-solid fa-check"></i> Ignorer
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function openDeleteReportedModal(jobId, reportId) {
            jobIdToAction = jobId; reportIdToAction = reportId;
            openModal('modal-delete-reported');
        }

        function openDismissReportModal(reportId) {
            reportIdToAction = reportId;
            openModal('modal-dismiss-report');
        }

        async function confirmDeleteReported() {
            if (jobIdToAction && reportIdToAction) {
                try {
                    await fetch(`api.php?action=delete_job&id=${jobIdToAction}`);
                    await fetch(`api.php?action=delete_report&id=${reportIdToAction}`);
                    showToast("Offre et signalement supprimés", "success");
                    loadReports(); loadJobs();
                    closeModal('modal-delete-reported');
                } catch (e) { showToast("Erreur système", "danger"); }
            }
        }

        async function confirmDismissReport() {
            if (reportIdToAction) {
                try {
                    await fetch(`api.php?action=delete_report&id=${reportIdToAction}`);
                    showToast("Signalement ignoré", "success");
                    loadReports();
                    closeModal('modal-dismiss-report');
                } catch (e) { showToast("Erreur système", "danger"); }
            }
        }

        // --- NAVIGATION VISUELLE ---
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active-link'));
            document.getElementById('view-' + viewId).classList.add('active');
            document.getElementById('nav-' + viewId).classList.add('active-link');
        }

        // --- GESTION DES NOTIFICATIONS TOAST ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colorClass = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

            toast.className = `toast flex items-center gap-3 ${colorClass} text-white px-4 py-3 rounded-lg shadow-lg min-w-[300px]`;
            toast.innerHTML = `<i class="fa-solid ${iconClass}"></i> <span class="font-medium text-sm">${message}</span>`;
            
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>